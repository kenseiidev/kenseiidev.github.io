<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>L√¨ X√¨ T·∫øt B√≠nh Ng·ªç 2026 üßß</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&family=Quicksand:wght@400;600;700&family=Noto+Serif:wght@700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Quicksand', sans-serif;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c44569 100%);
            overflow: hidden;
            height: 100vh;
            position: relative;
        }

        /* Pattern overlay */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 215, 0, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Welcome Screen */
        #welcomeScreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c44569 100%);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeIn 0.5s ease;
        }

        #welcomeScreen.hidden {
            animation: fadeOut 0.5s ease forwards;
            pointer-events: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; visibility: hidden; }
        }

        .welcome-content {
            text-align: center;
            padding: 3rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            animation: scaleIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes scaleIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .welcome-title {
            font-family: 'Pacifico', cursive;
            font-size: 2.5rem;
            color: #ff6b6b;
            margin-bottom: 1rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .welcome-subtitle {
            font-size: 1.3rem;
            color: #333;
            margin-bottom: 2rem;
            font-weight: 600;
        }

        .name-input {
            width: 100%;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            border: 3px solid #ff6b6b;
            border-radius: 50px;
            outline: none;
            margin-bottom: 1.5rem;
            font-family: 'Quicksand', sans-serif;
            transition: all 0.3s ease;
        }

        .name-input:focus {
            border-color: #c44569;
            box-shadow: 0 0 0 4px rgba(255, 107, 107, 0.2);
        }

        .start-button {
            padding: 1rem 3rem;
            font-size: 1.2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #ff6b6b, #c44569);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
            box-shadow: 0 5px 15px rgba(196, 69, 105, 0.4);
        }

        .start-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(196, 69, 105, 0.6);
        }

        .start-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Game Container */
        #gameContainer {
            display: none;
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        #gameContainer.active {
            display: block;
        }

        /* Improved Red Envelope - More like üßß */
        .red-envelope {
            position: absolute;
            width: 90px;
            height: 130px;
            cursor: pointer;
            animation: fall linear infinite;
            z-index: 10;
            transition: all 0.3s ease;
            filter: drop-shadow(0 8px 15px rgba(0, 0, 0, 0.3));
        }

        .red-envelope:hover {
            transform: scale(1.15);
            filter: drop-shadow(0 12px 25px rgba(0, 0, 0, 0.4)) brightness(1.1);
        }

        .envelope-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e63946 0%, #d62828 50%, #ba181b 100%);
            border-radius: 10px;
            position: relative;
            border: 3px solid #ffd60a;
            box-shadow: 
                inset 0 2px 10px rgba(255, 255, 255, 0.3),
                inset 0 -2px 10px rgba(0, 0, 0, 0.2);
        }

        /* Golden border decoration */
        .envelope-body::before {
            content: '';
            position: absolute;
            inset: 8px;
            border: 2px solid #ffd60a;
            border-radius: 6px;
            pointer-events: none;
        }

        /* Top flap - rounded arc like real envelope */
        .envelope-flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 45%;
            background: linear-gradient(135deg, #c1121f 0%, #a4161a 100%);
            clip-path: ellipse(60% 100% at 50% 0%);
            border-radius: 10px 10px 0 0;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        }

        /* Golden seal/decoration */
        .envelope-decoration {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 55px;
            height: 55px;
            background: radial-gradient(circle, #ffd60a 0%, #ffb703 50%, #fb8500 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 900;
            color: #d62828;
            border: 3px solid #ffee32;
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.3),
                inset 0 2px 5px rgba(255, 255, 255, 0.5);
            font-family: 'Noto Serif', serif;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
        }

        /* Chinese pattern decoration */
        .envelope-pattern {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            pointer-events: none;
        }

        .pattern-corner {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 214, 10, 0.4);
        }

        .pattern-corner.top-left {
            top: 15px;
            left: 15px;
            border-right: none;
            border-bottom: none;
            border-radius: 8px 0 0 0;
        }

        .pattern-corner.top-right {
            top: 15px;
            right: 15px;
            border-left: none;
            border-bottom: none;
            border-radius: 0 8px 0 0;
        }

        .pattern-corner.bottom-left {
            bottom: 15px;
            left: 15px;
            border-right: none;
            border-top: none;
            border-radius: 0 0 0 8px;
        }

        .pattern-corner.bottom-right {
            bottom: 15px;
            right: 15px;
            border-left: none;
            border-top: none;
            border-radius: 0 0 8px 0;
        }

        @keyframes fall {
            0% {
                top: -150px;
                transform: translateX(0) rotate(0deg);
            }
            100% {
                top: 110vh;
                transform: translateX(var(--drift)) rotate(360deg);
            }
        }

        /* Opened Envelope Modal */
        #envelopeModal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        #envelopeModal.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        .modal-envelope {
            position: relative;
            width: 320px;
            height: 480px;
            animation: zoomIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        @keyframes zoomIn {
            from {
                transform: scale(0.3) rotate(-10deg);
                opacity: 0;
            }
            to {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .modal-envelope-body {
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #e63946 0%, #d62828 50%, #ba181b 100%);
            border-radius: 20px;
            position: relative;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6);
            border: 4px solid #ffd60a;
        }

        /* Golden border on modal envelope */
        .modal-envelope-body::before {
            content: '';
            position: absolute;
            inset: 12px;
            border: 3px solid #ffd60a;
            border-radius: 14px;
            pointer-events: none;
        }

        /* Decorative pattern on modal envelope */
        .modal-envelope-body::after {
            content: 'Êò•';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 8rem;
            font-weight: 900;
            color: rgba(255, 214, 10, 0.15);
            font-family: 'Noto Serif', serif;
            pointer-events: none;
            z-index: 0;
        }

        .modal-envelope-flap {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 38%;
            background: linear-gradient(135deg, #c1121f 0%, #a4161a 100%);
            clip-path: ellipse(60% 100% at 50% 0%);
            border-radius: 20px 20px 0 0;
            transition: transform 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            transform-origin: top center;
            cursor: pointer;
            z-index: 2;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        .modal-envelope-flap.opened {
            transform: rotateX(-180deg);
        }

        .swipe-hint {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 1.2rem;
            font-weight: 700;
            text-shadow: 2px 2px 6px rgba(0, 0, 0, 0.7);
            animation: bounceUp 1s infinite;
            z-index: 3;
            pointer-events: none;
            background: rgba(255, 214, 10, 0.2);
            padding: 0.5rem 1.5rem;
            border-radius: 50px;
            border: 2px solid rgba(255, 214, 10, 0.5);
        }

        @keyframes bounceUp {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-15px); }
        }

        @keyframes bounce {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* Beautiful money paper */
        .money-paper {
            position: absolute;
            top: 45%;
            left: 50%;
            transform: translate(-50%, 0) scale(0);
            width: 240px;
            padding: 1.8rem;
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 50%, #fde68a 100%);
            border: 3px solid #fbbf24;
            border-radius: 15px;
            text-align: center;
            box-shadow: 
                0 15px 40px rgba(0, 0, 0, 0.4),
                inset 0 2px 10px rgba(255, 255, 255, 0.5);
            transition: all 0.7s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1;
            position: relative;
        }

        /* Decorative corners on money paper */
        .money-paper::before {
            content: '';
            position: absolute;
            inset: 8px;
            border: 2px solid rgba(251, 191, 36, 0.3);
            border-radius: 14px;
            pointer-events: none;
        }

        /* Chinese pattern on money paper */
        .money-paper::after {
            content: 'Ë≤°';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10rem;
            font-weight: 900;
            color: rgba(251, 191, 36, 0.1);
            font-family: 'Noto Serif', serif;
            pointer-events: none;
            z-index: -1;
        }

        .money-paper.show {
            transform: translate(-50%, -50%) scale(1);
            top: 50%;
        }

        .money-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #d97706;
            margin-bottom: 0.8rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
        }

        .money-amount {
            font-size: 2.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 1rem 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            z-index: 1;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
        }

        .money-wish {
            font-size: 0.95rem;
            color: #92400e;
            margin-top: 1rem;
            line-height: 1.6;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        .close-modal {
            margin-top: 1.2rem;
            padding: 0.8rem 2rem;
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Quicksand', sans-serif;
            box-shadow: 0 5px 15px rgba(220, 38, 38, 0.4);
            position: relative;
            z-index: 1;
        }

        .close-modal:hover {
            background: linear-gradient(135deg, #b91c1c, #991b1b);
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.6);
        }

        /* Music Control */
        #musicControl {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 65px;
            height: 65px;
            background: linear-gradient(135deg, #ffd60a, #fbbf24);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 6px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
            border: 4px solid #fff;
        }

        #musicControl:hover {
            transform: scale(1.15);
            box-shadow: 0 10px 35px rgba(0, 0, 0, 0.4);
        }

        #musicControl.muted {
            background: linear-gradient(135deg, #94a3b8, #64748b);
        }

        .speaker-icon {
            font-size: 2rem;
        }

        /* Already Played Message */
        #alreadyPlayed {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c44569 100%);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        #alreadyPlayed.active {
            display: flex;
        }

        .already-played-content {
            text-align: center;
            padding: 3rem;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            animation: scaleIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .already-played-title {
            font-family: 'Pacifico', cursive;
            font-size: 2rem;
            color: #ff6b6b;
            margin-bottom: 1rem;
        }

        .already-played-message {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .already-played-amount {
            font-size: 2.5rem;
            font-weight: 900;
            color: #d63031;
            margin: 1rem 0;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2rem;
            }

            .red-envelope {
                width: 70px;
                height: 100px;
            }

            .envelope-decoration {
                width: 45px;
                height: 45px;
                font-size: 1.4rem;
            }

            .modal-envelope {
                width: 280px;
                height: 420px;
            }

            .money-paper {
                width: 220px;
                padding: 1.5rem;
            }

            .money-amount {
                font-size: 2.2rem;
            }

            .money-title {
                font-size: 1.1rem;
            }

            .money-wish {
                font-size: 0.85rem;
            }

            #musicControl {
                width: 55px;
                height: 55px;
                bottom: 20px;
                right: 20px;
            }
        }

        /* Confetti */
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            position: absolute;
            animation: confetti-fall 3s linear infinite;
        }

        @keyframes confetti-fall {
            0% {
                top: -10px;
                opacity: 1;
            }
            100% {
                top: 100vh;
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <!-- Audio element -->
    <audio id="bgMusic" loop autoplay>
        <source src="tet-music.mp3" type="audio/mpeg">
    </audio>

    <!-- Welcome Screen -->
    <div id="welcomeScreen">
        <div class="welcome-content">
            <div class="welcome-title">üßß L√¨ X√¨ T·∫øt 2026 üßß</div>
            <div class="welcome-subtitle">Ch√∫c M·ª´ng NƒÉm M·ªõi B√≠nh Ng·ªç!</div>
            <input type="text" id="nameInput" class="name-input" placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." maxlength="30">
            <button id="startButton" class="start-button">B·∫Øt ƒë·∫ßu nh·∫≠n l√¨ x√¨</button>
        </div>
    </div>

    <!-- Already Played Screen -->
    <div id="alreadyPlayed">
        <div class="already-played-content">
            <div class="already-played-title">üéâ B·∫°n ƒë√£ nh·∫≠n l√¨ x√¨ r·ªìi! üéâ</div>
            <div class="already-played-message">
                Xin ch√†o <strong id="playedName"></strong>!<br>
                B·∫°n ƒë√£ nh·∫≠n ƒë∆∞·ª£c:
            </div>
            <div class="already-played-amount" id="playedAmount"></div>
            <div class="already-played-message">
                Ch√∫c b·∫°n nƒÉm m·ªõi vui v·∫ª!<br>
                H·∫πn g·∫∑p l·∫°i nƒÉm sau! üéä
            </div>
        </div>
    </div>

    <!-- Game Container -->
    <div id="gameContainer">
        <!-- Red envelopes will be spawned here -->
    </div>

    <!-- Envelope Modal -->
    <div id="envelopeModal">
        <div class="modal-envelope">
            <div class="modal-envelope-body">
                <div class="modal-envelope-flap" id="envelopeFlap">
                </div>
                <div class="swipe-hint" id="swipeHint">üëÜ Vu·ªët l√™n ƒë·ªÉ m·ªü</div>
                <div class="money-paper" id="moneyPaper">
                    <div class="money-title">üéä Ch√∫c m·ª´ng! üéä</div>
                    <div class="money-amount" id="prizeAmount"></div>
                    <div class="money-wish">
                        Ch√∫c b·∫°n nƒÉm m·ªõi<br>
                        An khang - Th·ªãnh v∆∞·ª£ng!<br>
                        V·∫°n s·ª± nh∆∞ √Ω! üéâ
                    </div>
                    <button class="close-modal" id="closeModal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Music Control -->
    <div id="musicControl">
        <span class="speaker-icon">üîä</span>
    </div>

    <script>
        // Weighted prize system
        // M·ªói m·ª©c (tr·ª´ 20k, 25k): 10-12% 
        // Weighted prize system - PH∆Ø∆†NG √ÅN 1
        // 1.000ƒë v√† 5.000ƒë: 5% m·ªói c√°i = 10% total
        // 10.000ƒë v√† 15.000ƒë: 10% m·ªói c√°i = 20% total  
        // 20.000ƒë v√† 25.000ƒë: 20% m·ªói c√°i = 40% total
        // C√≤n l·∫°i (30k, 35k, 40k, 45k, 50k): 30% total = 6% m·ªói c√°i
        const prizePool = [
            // 1.000ƒë - 5%
            ...Array(5).fill(1000),
            // 5.000ƒë - 5%
            ...Array(5).fill(5000),
            // 10.000ƒë - 10%
            ...Array(10).fill(10000),
            // 15.000ƒë - 10%
            ...Array(10).fill(15000),
            // 20.000ƒë - 20%
            ...Array(20).fill(20000),
            // 25.000ƒë - 20%
            ...Array(20).fill(25000),
            // 30.000ƒë - 6%
            ...Array(6).fill(30000),
            // 35.000ƒë - 6%
            ...Array(6).fill(35000),
            // 40.000ƒë - 6%
            ...Array(6).fill(40000),
            // 45.000ƒë - 6%
            ...Array(6).fill(45000),
            // 50.000ƒë - 6%
            ...Array(6).fill(50000)
        ];
        // Total: 100 items = 100%
        // T·ªâ l·ªá: 1k=5%, 5k=5%, 10k=10%, 15k=10%, 
        //        20k=20%, 25k=20%, 30k=6%, 35k=6%, 
        //        40k=6%, 45k=6%, 50k=6%

        // Get real user IP address using api.country.is and ipify.org
        async function getUserIP() {
            // Try method 1: api.country.is
            try {
                const response = await fetch('https://api.country.is/', {
                    mode: 'cors',
                    cache: 'no-cache'
                });
                if (response.ok) {
                    const data = await response.json();
                    if (data.ip) {
                        console.log('‚úÖ Got IP from api.country.is:', data.ip);
                        return data.ip;
                    }
                }
            } catch (error) {
                console.warn('‚ùå api.country.is failed:', error.message);
            }
            
            // Try method 2: ipify.org (text format - very reliable)
            try {
                const response = await fetch('https://api.ipify.org/', {
                    mode: 'cors',
                    cache: 'no-cache'
                });
                if (response.ok) {
                    const ip = await response.text();
                    if (ip && ip.trim()) {
                        console.log('‚úÖ Got IP from ipify.org:', ip.trim());
                        return ip.trim();
                    }
                }
            } catch (error) {
                console.warn('‚ùå ipify.org failed:', error.message);
            }
            
            // Fallback to enhanced fingerprint
            console.warn('‚ö†Ô∏è Both IP APIs failed! Using enhanced fingerprint as fallback.');
            return getEnhancedFingerprint();
        }
        
        // Enhanced fingerprint (better than simple random)
        function getEnhancedFingerprint() {
            const stored = localStorage.getItem('userFingerprint');
            if (stored) return stored;
            
            // Create fingerprint from multiple browser properties
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('fingerprint', 2, 2);
            const canvasData = canvas.toDataURL();
            
            const fingerprint = 'fp_' + 
                navigator.userAgent.length +
                '_' + screen.width + 'x' + screen.height +
                '_' + new Date().getTimezoneOffset() +
                '_' + navigator.language +
                '_' + canvasData.slice(-20).replace(/[^a-zA-Z0-9]/g, '');
            
            localStorage.setItem('userFingerprint', fingerprint);
            return fingerprint;
        }

        // Google Sheets API URL
        const SHEETS_API_URL = 'https://script.google.com/macros/s/AKfycbz-qElmaofsGGRb6JY43Id3xZdmbct6oUjMXI4pkbvsTrgN68PcxTsIYDxgIEeMxarZ/exec';

        // Check if IP already played (using Google Sheets)
        async function hasUserPlayed() {
            try {
                const userIP = await getUserIP();
                const url = `${SHEETS_API_URL}?action=checkIP&ip=${encodeURIComponent(userIP)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.played) {
                    console.log('‚úÖ User already played:', data);
                    return data;
                }
                return null;
            } catch (error) {
                console.error('Error checking user:', error);
                return null;
            }
        }

        // Save player data to Google Sheets
        async function savePlayerData(name, prize) {
            try {
                const userIP = await getUserIP();
                const url = `${SHEETS_API_URL}?action=save&name=${encodeURIComponent(name)}&prize=${prize}&ip=${encodeURIComponent(userIP)}&timestamp=${encodeURIComponent(new Date().toISOString())}&device=${encodeURIComponent(navigator.userAgent)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('‚úÖ Data saved to Google Sheets:', data);
            } catch (error) {
                console.error('Error saving to Google Sheets:', error);
            }
        }

        // Elements
        const welcomeScreen = document.getElementById('welcomeScreen');
        const alreadyPlayedScreen = document.getElementById('alreadyPlayed');
        const gameContainer = document.getElementById('gameContainer');
        const nameInput = document.getElementById('nameInput');
        const startButton = document.getElementById('startButton');
        const musicControl = document.getElementById('musicControl');
        const bgMusic = document.getElementById('bgMusic');
        const envelopeModal = document.getElementById('envelopeModal');
        const envelopeFlap = document.getElementById('envelopeFlap');
        const moneyPaper = document.getElementById('moneyPaper');
        const prizeAmount = document.getElementById('prizeAmount');
        const closeModal = document.getElementById('closeModal');
        const swipeHint = document.getElementById('swipeHint');

        let userName = '';
        let isMusicPlaying = false;
        let hasOpened = false;
        let hasSwipedToOpen = false;
        let userHasPlayed = false; // Track if user already played

        // Check if already played on page load (in background, non-blocking)
        window.addEventListener('DOMContentLoaded', async () => {
            // Don't block UI - check in background
            checkUserPlayedStatus();
        });
        
        // Background check for played status
        async function checkUserPlayedStatus() {
            const playedData = await hasUserPlayed();
            if (playedData) {
                userHasPlayed = true;
                document.getElementById('playedName').textContent = playedData.name;
                document.getElementById('playedAmount').textContent = parseInt(playedData.prize).toLocaleString('vi-VN') + ' VNƒê';
                
                // Only show if user is still on welcome screen
                if (!welcomeScreen.classList.contains('hidden')) {
                    alreadyPlayedScreen.classList.add('active');
                }
            }
        }

        // Enable start button when name is entered
        nameInput.addEventListener('input', () => {
            startButton.disabled = nameInput.value.trim().length === 0;
        });

        // Start game
        startButton.addEventListener('click', async () => {
            const name = nameInput.value.trim();
            if (name) {
                // Show loading
                startButton.disabled = true;
                startButton.textContent = 'ƒêang ki·ªÉm tra...';
                
                // Quick check if already played (in case background check hasn't finished)
                if (!userHasPlayed) {
                    const playedData = await hasUserPlayed();
                    if (playedData) {
                        userHasPlayed = true;
                        document.getElementById('playedName').textContent = playedData.name;
                        document.getElementById('playedAmount').textContent = parseInt(playedData.prize).toLocaleString('vi-VN') + ' VNƒê';
                        welcomeScreen.classList.add('hidden');
                        alreadyPlayedScreen.classList.add('active');
                        return;
                    }
                }
                
                // Check again right before starting (double check)
                if (userHasPlayed) {
                    welcomeScreen.classList.add('hidden');
                    alreadyPlayedScreen.classList.add('active');
                    return;
                }
                
                userName = name;
                
                // Force play music on user interaction (button click)
                bgMusic.play().then(() => {
                    isMusicPlaying = true;
                    console.log('üéµ Music playing');
                }).catch(e => {
                    console.log('Music blocked. Click speaker to play.');
                    isMusicPlaying = false;
                });
                
                welcomeScreen.classList.add('hidden');
                
                setTimeout(() => {
                    gameContainer.classList.add('active');
                    startEnvelopeRain();
                }, 500);
            }
        });

        // Play music
        function playMusic() {
            if (bgMusic.src && bgMusic.src !== window.location.href) {
                bgMusic.play().catch(e => {
                    console.log('Auto-play prevented. Click speaker to play music.');
                });
                isMusicPlaying = true;
            }
        }

        // Music control
        musicControl.addEventListener('click', () => {
            if (isMusicPlaying) {
                bgMusic.pause();
                musicControl.classList.add('muted');
                musicControl.querySelector('.speaker-icon').textContent = 'üîá';
                isMusicPlaying = false;
            } else {
                bgMusic.play();
                musicControl.classList.remove('muted');
                musicControl.querySelector('.speaker-icon').textContent = 'üîä';
                isMusicPlaying = true;
            }
        });

        // Create falling envelopes with improved design
        function createEnvelope() {
            if (hasOpened) return;

            const envelope = document.createElement('div');
            envelope.className = 'red-envelope';
            envelope.style.left = Math.random() * (window.innerWidth - 90) + 'px';
            envelope.style.setProperty('--drift', (Math.random() - 0.5) * 200 + 'px');
            envelope.style.animationDuration = (Math.random() * 2 + 4) + 's';
            
            const blessings = ['Á¶è', 'Ë≤°', 'Âñú', 'Êò•', 'Á•ø', 'Â£Ω'];
            const blessing = blessings[Math.floor(Math.random() * blessings.length)];
            
            envelope.innerHTML = `
                <div class="envelope-body">
                    <div class="envelope-flap"></div>
                    <div class="envelope-decoration">${blessing}</div>
                    <div class="envelope-pattern">
                        <div class="pattern-corner top-left"></div>
                        <div class="pattern-corner top-right"></div>
                        <div class="pattern-corner bottom-left"></div>
                        <div class="pattern-corner bottom-right"></div>
                    </div>
                </div>
            `;
            
            envelope.addEventListener('click', () => {
                if (!hasOpened) {
                    openEnvelope(envelope);
                }
            });
            
            gameContainer.appendChild(envelope);
            
            setTimeout(() => {
                if (envelope.parentNode) {
                    envelope.remove();
                }
            }, parseFloat(envelope.style.animationDuration) * 1000);
        }

        // Start envelope rain - MORE ENVELOPES!
        let envelopeInterval;
        function startEnvelopeRain() {
            // Create MORE initial envelopes (increased from 5 to 12)
            for (let i = 0; i < 12; i++) {
                setTimeout(() => createEnvelope(), i * 300);
            }
            
            // Continue creating envelopes MORE FREQUENTLY (reduced from 1500ms to 800ms)
            envelopeInterval = setInterval(() => {
                if (!hasOpened) {
                    // Create 2 envelopes at once sometimes for more density
                    createEnvelope();
                    if (Math.random() > 0.5) {
                        setTimeout(() => createEnvelope(), 200);
                    }
                }
            }, 800);
        }

        // Open envelope modal
        async function openEnvelope(envelope) {
            hasOpened = true;
            hasSwipedToOpen = false; // Reset swipe flag
            clearInterval(envelopeInterval);
            
            document.querySelectorAll('.red-envelope').forEach(env => env.remove());
            
            envelopeModal.classList.add('active');
            
            // Random prize from weighted pool
            const prize = prizePool[Math.floor(Math.random() * prizePool.length)];
            prizeAmount.textContent = prize.toLocaleString('vi-VN') + ' VNƒê';
            
            await savePlayerData(userName, prize);
            
            // User must swipe up to open - no auto-open!
        }

        // Swipe up to open envelope - FIXED VERSION
        let touchStartY = 0;
        let touchStartTime = 0;
        
        // Prevent default click behavior on modal to force swipe
        const modalBody = document.querySelector('.modal-envelope-body');
        
        modalBody.addEventListener('click', (e) => {
            // Prevent click from opening - MUST swipe!
            e.preventDefault();
            e.stopPropagation();
        });
        
        modalBody.addEventListener('touchstart', (e) => {
            if (hasSwipedToOpen) return;
            touchStartY = e.touches[0].clientY;
            touchStartTime = Date.now();
        }, { passive: false });

        modalBody.addEventListener('touchmove', (e) => {
            if (hasSwipedToOpen) return;
            
            const touchY = e.touches[0].clientY;
            const diff = touchStartY - touchY; // Positive = swipe up
            const timeDiff = Date.now() - touchStartTime;
            
            // Swipe up at least 100px with reasonable speed
            if (diff > 100 && timeDiff < 800 && !hasSwipedToOpen) {
                hasSwipedToOpen = true;
                openFlap();
            }
        }, { passive: false });

        // For desktop - allow click but make it clear it's for desktop only
        let clickCount = 0;
        modalBody.addEventListener('mousedown', (e) => {
            if (hasSwipedToOpen) return;
            clickCount++;
            if (clickCount >= 1) {
                hasSwipedToOpen = true;
                openFlap();
            }
        });

        function openFlap() {
            envelopeFlap.classList.add('opened');
            swipeHint.style.display = 'none';
            
            setTimeout(() => {
                moneyPaper.classList.add('show');
                createConfetti();
            }, 800);
        }

        // Close modal
        closeModal.addEventListener('click', () => {
            envelopeModal.classList.remove('active');
            
            setTimeout(() => {
                const playedData = hasUserPlayed();
                document.getElementById('playedName').textContent = playedData.name;
                document.getElementById('playedAmount').textContent = playedData.prize.toLocaleString('vi-VN') + ' VNƒê';
                alreadyPlayedScreen.classList.add('active');
            }, 300);
        });

        // Create confetti
        function createConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#ffed4e', '#ff4757', '#fff', '#fbbf24'];
            for (let i = 0; i < 80; i++) {
                setTimeout(() => {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * window.innerWidth + 'px';
                    confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                    confetti.style.animationDelay = Math.random() * 0.5 + 's';
                    confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                    confetti.style.width = (Math.random() * 8 + 6) + 'px';
                    confetti.style.height = confetti.style.width;
                    document.body.appendChild(confetti);
                    
                    setTimeout(() => confetti.remove(), 3000);
                }, i * 25);
            }
        }

        startButton.disabled = true;
    </script>
</body>
</html>
